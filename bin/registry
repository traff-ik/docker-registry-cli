#!/usr/bin/env php
<?php

declare(strict_types=1);

error_reporting(E_ALL);

use Amp\Loop;
use Amp\Http\Client\HttpClientBuilder;
use League\CLImate\CLImate;
use League\CLImate\Logger;
use Psr\Log\LogLevel;
use Traff\Registry;

require dirname(__DIR__) . DIRECTORY_SEPARATOR . 'vendor' . DIRECTORY_SEPARATOR . 'autoload.php';

$args = [
    'help' => [
        'noValue' => true,
        'longPrefix' => 'help',
        'description' => 'Show help message',
    ],
    'verbose' => [
        'noValue' => true,
        'prefix' => 'v',
        'longPrefix' => 'verbose',
        'description' => 'Verbose output',
    ],
    'registry' => [
        'prefix' => 'r',
        'longPrefix' => 'registry',
        'description' => 'Registry URL',
        'castTo' => 'string',
    ],
    'delete' => [
        'prefix' => 'd',
        'longPrefix' => 'delete',
        'noValue' => true,
        'description' => 'Delete the image'
    ],
    'tag' => [
        'prefix' => 't',
        'longPrefix' => 'tag',
        'description' => 'Image with tag IMAGE[:TAG] (tag :latest by default)',
        'castTo' => 'string',
    ],
    'info' => [
        'prefix' => 'i',
        'longPrefix' => 'info',
        'description' => 'Some information',
        'noValue' => true,
    ]
];

$climate = new CLImate();
$climate->description('Docker registry CLI');
$climate->arguments->add($args);

try {
    $climate->arguments->parse();
} catch (Exception $e) {
    $climate->error(sprintf('Invalid arguments: %s', $e->getMessage()));
    $climate->usage();
    exit(1);
}

if (count($argv) < 3 || $climate->arguments->defined('help')) {
    $climate->usage();
    exit(0);
}

if (! $climate->arguments->defined('registry')) {
    $climate->error('Registry URL must be provided. Use "-r" or "--registry" argument');
    exit(1);
}

$verbose = $climate->arguments->defined('verbose');
$registry_url = $climate->arguments->get('registry');
$level = $verbose ? LogLevel::DEBUG : LogLevel::INFO;

if (! $climate->arguments->get('registry')) {
    $climate->error('Registry URL must be provided');
    exit(1);
}

$climate->style->addCommand(LogLevel::DEBUG, 'light_magenta');
$cli_logger = new Logger($level, $climate);
$formatter = new Registry\Logger\LineFormatter("[%channel%][%level_name%] %message% %context%");
$handler = new Registry\Logger\ClImateHandler($cli_logger);
$handler->setFormatter($formatter);
$logger = new \Monolog\Logger('registry', [$handler]);

$http_client = new Registry\HttpClient((new HttpClientBuilder())->build());

$registry = new Registry\Registry(
    $registry_url,
    $http_client,
    $logger,
    new Registry\Factory\ImageFactory()
);

$logger->debug('Set registry URL as {url}', ['url' => $registry_url]);

Loop::defer(
    static function () use ($verbose, &$climate, &$registry): Generator {
        try {
            try {
                if ($climate->arguments->defined('delete')) {
                    if (! $climate->arguments->defined('tag')) {
                        $climate->to('error')->error('Image name must be provided. Use "-t" or "--tag" argument');
                        exit(1);
                    }

                    yield $registry->deleteTag($climate->arguments->get('tag'));
                } elseif ($climate->arguments->defined('info')) {
                    if ($climate->arguments->defined('tag')) {
                        $image = yield $registry->getTagDigest($climate->arguments->get('tag'));

                        $data = [
                            [
                                'Image',
                                'Tag Digest',
                            ],
                            [
                                (string) $image,
                                (string) $image->getTag()->getDigest(),
                            ],
                        ];

                        $climate->table($data);
                    }
                }
            } catch (Error $e) {
                $climate->to('error')->error($e->getMessage());
                exit(((int) $e->getCode()) ?: 1);
            }

            exit(0);
        } catch (Throwable $e) {
            if ($verbose) {
                throw $e;
            }

            $climate->to('error')->error($e->getMessage());
        }
    }
);

Loop::run();
